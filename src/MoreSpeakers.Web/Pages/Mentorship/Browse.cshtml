@page
@model MoreSpeakers.Web.Pages.Mentorship.BrowseModel
@{
    ViewData["Title"] = "Find a Mentor";
    var clearAllStyle = Model.SelectedExpertise.Any() ? "" : "display: none;";
}

<div class="container-fluid">
    <div class="row">
        <!-- Filter Panel -->
        <div class="col-lg-3 mb-4">
            <div class="mentorship-filters card sticky-top" style="top: 1rem;">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Find Your Mentor
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Type Selection -->
                    <div class="mb-4">
                        <p class="lead">Mentorship Type</p>
                        <div role="group">
                            <input type="radio" name="mentorshipType" value="NewToExperienced"
                                   class="btn-check" id="type-new"
                                   @(Model.MentorshipType == Domain.Models.MentorshipType.NewToExperienced ? "checked" : "")
                                   hx-get="/Mentorship/Browse?handler=SearchMentors"
                                   hx-target="#mentor-results"
                                   hx-include="[name='expertise']:checked,[name='availability']:checked"
                                   hx-indicator="#search-loading">
                            <label class="btn btn-outline-primary" for="type-new">
                                <i class="bi bi-people"></i>
                                <div class="d-flex flex-column">
                                    <span class="fw-bold">Find Mentor</span>
                                    <small class="text-muted">Get guidance from experienced speakers</small>
                                </div>
                            </label>

                            <input type="radio" name="mentorshipType" value="ExperiencedToExperienced"
                                   class="btn-check" id="type-peer"
                                   @(Model.MentorshipType == Domain.Models.MentorshipType.ExperiencedToExperienced ? "checked" : "")
                                   hx-get="/Mentorship/Browse?handler=SearchMentors"
                                   hx-target="#mentor-results"
                                   hx-include="[name='expertise']:checked,[name='availability']:checked"
                                   hx-indicator="#search-loading">
                            <label class="btn btn-outline-primary" for="type-peer">
                                <i class="bi bi-person-plus me-2"></i>
                                <div class="d-flex flex-column">
                                    <span class="fw-bold">Find Peer</span>
                                    <small class="text-muted">Connect with fellow experienced speakers</small>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Expertise Filter -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <p class="fs-5">Expertise Areas</p>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <button type="button"
                                    id="clearAllBtn"
                                    style="display:none;"
                                    class="btn btn-sm btn-link text-danger p-0"
                                    onclick="(function(btn){ const checks=document.querySelectorAll('input[name=expertise]:checked'); checks.forEach(cb=>{ cb.checked=false; const item=cb.closest('.expertise-filter-item'); if(item){ item.classList.remove('selected'); }}); btn.style.display='none'; const mt=document.querySelector('input[name=mentorshipType]:checked'); if(mt){ htmx.trigger(mt,'change'); } })(this)">
                                <i class="bi bi-x-circle me-1"></i>Clear All
                            </button>
                        </div>
                        <div class="">
                            @foreach (var expertise in Model.AvailableExpertise.Take(20))
                            {
                                <div
                                    class="form-check form-switch @(Model.SelectedExpertise.Contains(expertise.Name) ? "selected" : "")">
                                    <input class="form-check-input" type="checkbox" switch
                                           name="expertise" value="@expertise.Name"
                                           id="exp-@expertise.Id"
                                           @(Model.SelectedExpertise.Contains(expertise.Name) ? "checked" : "")
                                           hx-get="/Mentorship/Browse?handler=SearchMentors"
                                           hx-target="#mentor-results"
                                           hx-include="[name='mentorshipType']:checked,[name='availability']:checked,[name='expertise']:checked"
                                           hx-trigger="change"
                                           hx-indicator="#search-loading"
                                           onchange="(function(inp){ const item=inp.closest('.expertise-filter-item'); if(inp.checked){ if(item){ item.classList.add('selected'); } } else { if(item){ item.classList.remove('selected'); } } if(document.querySelectorAll('input[name=expertise]:checked').length>0){ document.getElementById('clearAllBtn').style.display=''; } else { document.getElementById('clearAllBtn').style.display='none'; } })(this)">
                                    <label class="w-100" for="exp-@expertise.Id">@expertise.Name</label>
                                </div>
                            }
                        </div>
                        @if (Model.AvailableExpertise.Count > 20)
                        {
                            <button class="btn btn-sm btn-outline-secondary mt-2 w-100" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#moreExpertise">
                                Show More (+@(Model.AvailableExpertise.Count - 20))
                            </button>
                            <div class="collapse mt-2" id="moreExpertise">
                                <div>
                                    @foreach (var expertise in Model.AvailableExpertise.Skip(20))
                                    {
                                        <div
                                            class="form-check form-switch @(Model.SelectedExpertise.Contains(expertise.Name) ? "selected" : "")">
                                            <input class="form-check-input" type="checkbox" switch
                                                   name="expertise" value="@expertise.Name"
                                                   id="exp-@expertise.Id"
                                                   @(Model.SelectedExpertise.Contains(expertise.Name) ? "checked" : "")
                                                   hx-get="/Mentorship/Browse?handler=SearchMentors"
                                                   hx-target="#mentor-results"
                                                   hx-include="[name='mentorshipType']:checked,[name='availability']:checked,[name='expertise']:checked"
                                                   hx-trigger="change"
                                                   hx-indicator="#search-loading"
                                                   onchange="(function(inp){ const item=inp.closest('.expertise-filter-item'); if(inp.checked){ if(item){ item.classList.add('selected'); } } else { if(item){ item.classList.remove('selected'); } } if(document.querySelectorAll('input[name=expertise]:checked').length>0){ document.getElementById('clearAllBtn').style.display=''; } else { document.getElementById('clearAllBtn').style.display='none'; } })(this)">
                                            <label class="w-100" for="exp-@expertise.Id">@expertise.Name</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                    
                    <!-- Search Loading Indicator -->
                    <div id="search-loading" class="htmx-indicator text-center">
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Searching...</span>
                        </div>
                        <small class="d-block text-muted mt-1">Searching mentors...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Available Mentors</h2>
                    <p class="text-muted mb-0">Connect with experienced speakers who can guide your journey</p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary" id="view-grid">
                        <i class="bi bi-grid-3x3-gap"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="view-list">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>

            <div id="mentor-results">
                @await Html.PartialAsync("_MentorResults.cshtml", Model.ViewModel)
            </div>
        </div>
    </div>
</div>

<!-- Modal Container -->
<div id="modal-container"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Handle view toggle
        document.getElementById('view-grid')?.addEventListener('click', function () {
            document.getElementById('mentor-results').classList.remove('list-view');
            this.classList.add('active');
            document.getElementById('view-list').classList.remove('active');
        });

        document.getElementById('view-list')?.addEventListener('click', function () {
            document.getElementById('mentor-results').classList.add('list-view');
            this.classList.add('active');
            document.getElementById('view-grid').classList.remove('active');
        });
    });
</script>