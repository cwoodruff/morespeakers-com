@page
@model MoreSpeakers.Web.Areas.Admin.Pages.Users.IndexModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "Users";
    var q = Model.Query;
    int totalPages = (int)Math.Ceiling((double)Model.Result.TotalCount / Math.Max(1, Model.Result.PageSize));
    totalPages = Math.Max(1, totalPages);

    string SortDirFor(string col)
    {
        var isSame = string.Equals(q.Sort, col, StringComparison.OrdinalIgnoreCase);
        var dir = isSame && string.Equals(q.Dir, "asc", StringComparison.OrdinalIgnoreCase) ? "desc" : "asc";
        return dir;
    }

    string CaretFor(string col)
    {
        var isActive = string.Equals(q.Sort, col, StringComparison.OrdinalIgnoreCase);
        if (!isActive) return "";
        var asc = string.Equals(q.Dir, "asc", StringComparison.OrdinalIgnoreCase);
        return asc ? "<i class=\"bi bi-caret-up-fill ms-1\"></i>" : "<i class=\"bi bi-caret-down-fill ms-1\"></i>";
    }
}

<div class="d-flex align-items-center mb-3">
    <h2 class="mb-0">Users</h2>
    <span class="text-muted ms-3">@Model.Result.TotalCount total</span>
  </div>

<form method="get" class="mb-3"
      hx-get hx-target="#user-list-container" hx-push-url="true" hx-trigger="change, submit"
      hx-indicator=".htmx-indicator">
  <div class="row g-2 align-items-end">
    <div class="col-12 col-md-4">
      <label for="q" class="form-label">Search (email or username)</label>
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" name="q" id="q" value="@q.Q" class="form-control" placeholder="Search..." />
      </div>
    </div>
    <div class="col-6 col-md-2">
      <label for="lockout" class="form-label">Lockout</label>
      <select class="form-select" id="lockout" name="lockout">
        <option value="any" selected="@(q.Lockout=="any" ? "selected" : null)">Any</option>
        <option value="locked" selected="@(q.Lockout=="locked" ? "selected" : null)">Locked out</option>
        <option value="notlocked" selected="@(q.Lockout=="notlocked" ? "selected" : null)">Not locked out</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label for="emailConfirmed" class="form-label">Email</label>
      <select class="form-select" id="emailConfirmed" name="emailConfirmed">
        <option value="any" selected="@(q.EmailConfirmed=="any" ? "selected" : null)">Any</option>
        <option value="true" selected="@(q.EmailConfirmed=="true" ? "selected" : null)">Confirmed</option>
        <option value="false" selected="@(q.EmailConfirmed=="false" ? "selected" : null)">Not confirmed</option>
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label for="role" class="form-label">Role</label>
      <select class="form-select" id="role" name="role">
        <option value="" selected="@string.IsNullOrWhiteSpace(q.Role)">Any</option>
        @foreach (var role in Model.Roles)
        {
          <option value="@role" selected="@(string.Equals(q.Role, role, StringComparison.OrdinalIgnoreCase) ? "selected" : null)">@role</option>
        }
      </select>
    </div>
    <div class="col-6 col-md-2">
      <label for="pageSize" class="form-label">Page size</label>
      <select class="form-select" id="pageSize" name="pageSize">
        @{ int[] sizes = new []{10,20,50,100}; }
        @foreach (var s in sizes)
        {
          <option value="@s" selected="@(q.PageSize==s ? "selected" : null)">@s</option>
        }
      </select>
    </div>
    <div class="col-12 col-md-12 d-flex gap-2">
      <button type="submit" class="btn btn-primary"><i class="bi bi-funnel me-1"></i>Apply</button>
      <a asp-area="Admin" asp-page="/Users/Index" class="btn btn-outline-secondary"
         hx-get hx-target="#user-list-container" hx-push-url="true"><i class="bi bi-arrow-counterclockwise me-1"></i>Reset</a>
      <div class="htmx-indicator spinner-border spinner-border-sm text-primary ms-auto mb-1" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
  </div>
</form>

<div id="user-list-container">
    @await Html.PartialAsync("_UserList", Model)
</div>
