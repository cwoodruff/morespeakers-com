@using MoreSpeakers.Web.Models.ViewModels
@model MoreSpeakers.Web.Areas.Identity.Pages.Account.RegisterModel

<div class="form-step" data-step="4">
    @if (ViewData["HasValidationErrors"] as bool? == true)
    {
        <div class="alert alert-danger mb-3">
            <i class="bi bi-exclamation-triangle me-2"></i>@ViewData["ValidationMessage"]
        </div>
    }
    @if (ViewData["SuccessMessage"] != null)
    {
        <div class="alert alert-success mb-3">
            <i class="bi bi-check-circle me-2"></i>@ViewData["SuccessMessage"]
        </div>
    }
    <div class="row mb-4">
        <div class="col-12">
            <h5 class="border-bottom pb-2 mb-3">
                <i class="bi bi-gear-fill me-2"></i>Social Media & Professional Links
            </h5>
            <div class="form-text mb-3">Share your professional social media profiles to help others connect with you.</div>
        </div>
        <div class="col-12" id="socialMediaContainer">
            <input type="hidden" name="socialMediaSitesCount" value="0" />
            @{
                var index = 0;
                var socialMediaSites = Model.SocialMediaSites?.ToList() ?? new List<MoreSpeakers.Domain.Models.SocialMediaSite>();
            }

            @if (Model.Input?.UserSocialMediaSites != null)
            {
                foreach (var userSocialMediaSite in Model.Input.UserSocialMediaSites)
                {
                    var model = new UserSocialMediaSiteRowViewModel
                    {
                        UserSocialMediaSite = userSocialMediaSite,
                        SocialMediaSites = socialMediaSites,
                        ItemNumber = index
                    };
                    index++;
                    @await Html.PartialAsync("_UserSocialMediaSiteRow", model)
                }
            }
        </div>
        <div id="replaceSocialMediaRow">
            <div id="addingRowSpinner" class="htmx-indicator">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Adding row...</span>
                </div>
                Adding row...
            </div>
            <button class="btn btn-primary float-end" type="button"
                    hx-get="/Register?handler=AddSocialMediaRow"
                    hx-target="[name=socialMediaSitesCount], :nth-last-child(1 of .social-media-row)"
                    hx-include="[name='socialMediaSitesCount'], [name^='Input.SocialMediaSiteId']"
                    hx-indicator="#addingRowSpinner"
                    hx-swap="afterend"
                    hx-on::after-request="document.querySelector('[name=socialMediaSitesCount]').value = document.querySelector(':nth-last-child(1 of .social-media-row)').dataset.id">
                <i class="bi bi-plus-square me-2"></i>Add
            </button>
        </div>
    </div>
</div>

<!-- Persist Steps 1-3 values across HTMX steps for final submit -->
<div aria-hidden="true" class="d-none">
    <!-- Step 1 fields -->
    <input type="hidden" asp-for="CurrentStep" />
    <input type="hidden" asp-for="Input.FirstName" />
    <input type="hidden" asp-for="Input.LastName" />
    <input type="hidden" asp-for="Input.Email" />
    <input type="hidden" asp-for="Input.PhoneNumber" />
    <input type="hidden" asp-for="Input.Password" />
    <input type="hidden" asp-for="Input.ConfirmPassword" />

    <!-- Step 2 fields -->
    <input type="hidden" asp-for="Input.Bio" />
    <input type="hidden" asp-for="Input.Goals" />
    <input type="hidden" asp-for="Input.SessionizeUrl" />
    <input type="hidden" asp-for="Input.HeadshotUrl" />
    <input type="hidden" asp-for="Input.SpeakerTypeId" />

    <!-- Step 3 fields (arrays need multiple hidden inputs) -->
    @if (Model?.Input?.SelectedExpertiseIds != null)
    {
        foreach (var id in Model.Input.SelectedExpertiseIds)
        {
            <input type="hidden" name="Input.SelectedExpertiseIds" value="@id" />
        }
    }
   
    @if (Model?.Input?.UserSocialMediaSites != null)
    {
        foreach (var usms in Model.Input.UserSocialMediaSites)
        {
            <input type="hidden" name="Input.UserSocialMediaSites" value="@usms" />
        }
    }
</div>
